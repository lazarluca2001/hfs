<script>
    /* --- LOKÁLIS KALKULÁCIÓS ADATOK --- */
    const hfsStats = [
        { name: "Ferenczi Csongor", div: "Intermediate", points: 19 },
        { name: "Bende Márton", div: "Novice", points: 15 },
        { name: "Angyal Mercédesz", div: "Novice", points: 4 },
        { name: "Lázár Luca", div: "Novice", points: 0 },
        { name: "Dominguez Zoltán", div: "Intermediate", points: 0 }
    ];

    const wsdcRules = {
        "Newcomer": { allowed: 0, required: 1, next: "Novice" },
        "Novice": { allowed: 16, required: 30, next: "Intermediate" },
        "Intermediate": { allowed: 30, required: 45, next: "Advanced" },
        "Advanced": { allowed: 60, required: 90, next: "All Star" }
    };

    const TIER_TABLE = {
        1: [3, 2, 1], 2: [6, 4, 3, 2, 1], 3: [10, 8, 6, 4, 2, 1],
        4: [15, 12, 10, 8, 6, 1], 5: [20, 16, 14, 12, 10, 2], 6: [25, 22, 18, 15, 12, 2]
    };

    /* --- INICIALIZÁLÁS --- */
    function initDashboard() {
        const sel = document.getElementById('memberSelect');
        if (sel) hfsStats.forEach((m, i) => sel.add(new Option(m.name, i)));
        
        const themeToggle = document.getElementById('theme-toggle');
        const isDark = localStorage.getItem('theme') === 'dark';
        document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
        if(themeToggle) {
            themeToggle.checked = isDark;
            themeToggle.onchange = (e) => {
                const theme = e.target.checked ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
            };
        }
    }

    /* --- KALKULÁTOR LOGIKA --- */
    function loadMemberData() {
        const idx = document.getElementById('memberSelect').value;
        if(idx !== "custom") {
            document.getElementById('currentDivision').value = hfsStats[idx].div;
            document.getElementById('currentPoints').value = hfsStats[idx].points;
        }
        calculate();
    }

    function calculate() {
        const div = document.getElementById('currentDivision').value;
        const pts = parseInt(document.getElementById('currentPoints').value) || 0;
        const rule = wsdcRules[div];
        if(!rule) return;

        let aDiff = Math.max(0, rule.allowed - pts);
        let rDiff = Math.max(0, rule.required - pts);
        
        document.getElementById('nextLevelResult').innerHTML = `
            <strong>KÖVETKEZŐ SZINT: ${rule.next.toUpperCase()}</strong><br>
            Szintlépés lehetséges: <span class="highlight">${aDiff}</span> pont múlva.<br>
            Szintlépés kötelező: <span class="highlight">${rDiff}</span> pont múlva.`;
    }

    /* --- VERSENY NAPLÓZÓ LOGIKA --- */
    function toggleNextSection(type) {
        if (type === 'semi') {
            const isPassing = document.getElementById('p_pass').checked;
            document.getElementById('section-semi').style.display = isPassing ? 'block' : 'none';
            if (!isPassing) {
                document.getElementById('s_pass').checked = false;
                toggleNextSection('final');
            }
        } else if (type === 'final') {
            const isPassing = document.getElementById('s_pass').checked;
            document.getElementById('section-final').style.display = isPassing ? 'block' : 'none';
            if (isPassing) generateJudgeInputs();
        }
    }

    function calcPrelim(prefix) {
        const y = parseInt(document.getElementById(`${prefix}_vYes`).value) || 0;
        const a1 = parseInt(document.getElementById(`${prefix}_vAlt1`).value) || 0;
        // Javítás: Pont használata vessző helyett és csak létező mezők számítása
        const score = (y * 10) + (a1 * 4.5);
        document.getElementById(`${prefix}_score`).innerText = `Pontszám: ${score}`;
    }

    function generateJudgeInputs() {
        const count = document.getElementById('finalJudgeCount').value;
        const container = document.getElementById('judgeInputsContainer');
        container.innerHTML = '';
        for (let i = 1; i <= count; i++) {
            container.innerHTML += `<input type="number" class="rp-input" placeholder="J${i}" style="width:55px; margin:2px;">`;
        }
    }

    function runRelativePlacement() {
        const inputs = document.querySelectorAll('.rp-input');
        const scores = Array.from(inputs).map(i => parseInt(i.value)).filter(v => !isNaN(v));
        if (scores.length < 3) return alert("Kérlek add meg a bírói helyezéseket!");

        const majority = Math.ceil(scores.length / 2);
        let finalPlace = 0;
        for (let p = 1; p <= 20; p++) {
            if (scores.filter(s => s <= p).length >= majority) {
                finalPlace = p;
                break;
            }
        }

        const count = parseInt(document.getElementById('competitorCount').value) || 0;
        let tier = 0;
        if (count >= 130) tier = 6; else if (count >= 80) tier = 5; else if (count >= 40) tier = 4;
        else if (count >= 20) tier = 3; else if (count >= 11) tier = 2; else if (count >= 5) tier = 1;

        const points = (TIER_TABLE[tier] && TIER_TABLE[tier][finalPlace - 1]) || 0;

        document.getElementById('finalResultDisplay').style.display = 'block';
        document.getElementById('finalPlaceText').innerText = `Végső helyezés: ${finalPlace}.`;
        document.getElementById('wsdcPointsEarned').innerText = `Szerzett WSDC pont: ${points}`;
    }

    window.addEventListener('DOMContentLoaded', initDashboard);
</script>
